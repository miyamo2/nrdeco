# nrdeco

[![Go Reference](https://pkg.go.dev/badge/github.com/miyamo2/nrdeco.svg)](https://pkg.go.dev/github.com/miyamo2/nrdeco)
[![GitHub go.mod Go version](https://img.shields.io/github/go-mod/go-version/miyamo2/nrdeco)](https://img.shields.io/github/go-mod/go-version/miyamo2/nrdeco)
[![GitHub release (latest by date)](https://img.shields.io/github/v/release/miyamo2/nrdeco)](https://img.shields.io/github/v/release/miyamo2/nrdeco)
[![Go Report Card](https://goreportcard.com/badge/github.com/miyamo2/nrdeco)](https://goreportcard.com/report/github.com/miyamo2/nrdeco)
[![GitHub License](https://img.shields.io/github/license/miyamo2/nrdeco?&color=blue)](https://img.shields.io/github/license/miyamo2/nrdeco?&color=blue)

**nrdeco** is a Go code generator that automatically adds New Relic APM Segments.

## üåü Highlights

| &nbsp;                           | &nbsp;                                                                   |
|----------------------------------|--------------------------------------------------------------------------|
| **ü§ñ Automatic Instrumentation** | Automatically generates New Relic APM segments from Go interfaces        |
| **üîå DI Friendly**               | Uses the decorator pattern for seamless dependency injection integration |
| **üéØ Context-Aware**             | Instruments only methods that accept `context.Context`                   |
| **üöÄ Cross-Platform**            | Works on Linux, macOS, and Windows                                       |
| **üì¶ Multiple Install Methods**  | Install via Go, Homebrew, or direct binary download                      |

## üì¶ Installation

### Using Go Install (Recommended)

```sh
go install github.com/miyamo2/nrdeco/cmd/nrdeco@latest
```

### Using Go Tool

```sh
go get -tool github.com/miyamo2/nrdeco/cmd/nrdeco
```

### Using Homebrew

```sh
brew install miyamo2/tap/nrdeco
```

### Direct Binary Download

Download the appropriate binary for your platform from [GitHub Releases](https://github.com/miyamo2/nrdeco/releases).

## üöÄ Quick Start

1. Define your interface with methods that include `context.Context` parameters

`repository.go`

```go
//go:generate nrdeco -s $GOFILE
package repository

import (
	"context"
	"github.com/miyamo2/nrdeco/examples/domain/model"
)

type UserRepository interface {
	GetUserByID(string) (*model.User, error)                             // Not instrumented - no context parameter
	GetAllUsers() ([]model.User, error)                                  // Not instrumented - no context parameter
	GetUserByIDWithContext(context.Context, string) (*model.User, error) // Instrumented - has context parameter
	GetAllUsersWithContext(context.Context) ([]model.User, error)        // Instrumented - has context parameter
}
```

2. Generate the instrumented code

```sh
go generate ./...
```

This generates a new file named `repository.nrdeco.go` containing the instrumented decorator implementation.

```go
// Code generated by nrdeco@; DO NOT EDIT.
//
// See here for more information on nrdeco: https://github.com/miyamo2/nrdeco
package repository

import (
	"context"
	"github.com/miyamo2/nrdeco/examples/domain/model"
	"github.com/newrelic/go-agent/v3/newrelic"
	"os"
	"strings"
)

// NRUserRepository implements repository.UserRepository with New Relic instrumentation.
type NRUserRepository struct {
	UserRepository
}

func (n *NRUserRepository) GetUserByIDWithContext(ctx context.Context, arg1 string) (*model.User, error) {
	if strings.ToLower(os.Getenv("NRDECO_ENABLED")) == "true" {
		defer newrelic.FromContext(ctx).StartSegment("repository.UserRepository.GetUserByIDWithContext").End()
	}
	return n.UserRepository.GetUserByIDWithContext(ctx, arg1)
}

func (n *NRUserRepository) GetAllUsersWithContext(ctx context.Context) ([]model.User, error) {
	if strings.ToLower(os.Getenv("NRDECO_ENABLED")) == "true" {
		defer newrelic.FromContext(ctx).StartSegment("repository.UserRepository.GetAllUsersWithContext").End()
	}
	return n.UserRepository.GetAllUsersWithContext(ctx)
}
```

3. Use the generated decorator in your application

```go
func main() {
    // Initialize New Relic
    app, err := newrelic.NewApplication(/* your config */)
    if err != nil {
        panic(err)
    }
    
    // Create your original repository implementation
    originalRepo := &UserRepository{}
    
    // Wrap it with the generated instrumented decorator
    instrumentedRepo := &repository.NRUserRepository{
        UserRepository: originalRepo,
    }

    // Create a transaction
    txn := app.StartTransaction("test_transaction")
    ctx := newrelic.NewContext(context.Background(), txn)
    
    // Use the instrumented repository - segments are automatically tracked
    user, err := instrumentedRepo.GetUserByIDWithContext(ctx, "123")
}
```

4. Enable instrumentation and run your application

```sh
export NRDECO_ENABLED=true
go run ./path/to/your/main.go
```

## üìã Usage

### Flags

| Flag             | Description                                     | Default              | Note                                    |
|------------------|-------------------------------------------------|----------------------|-----------------------------------------|
| `-s`, `--source` | Source file containing interfaces to instrument | -                    | Either this or `--version` is required. |
| `-d`, `--dest`   | Output file for generated code                  | `<source>.nrdeco.go` |                                         |
| `--version`      | Print version information                       | -                    | Either this or `--source` is required.  |
| `-h`, `--help`   | Show help message                               | -                    |                                         |

### Command Examples

```sh
# Generate instrumented code
nrdeco -s repository.go

# Generate with custom output location
nrdeco -s repository.go -d ../../infra/nr/repository_instrumented.go

# Check version
nrdeco --version
```

## ‚öôÔ∏è Configuration

### Environment Variables

| Variable         | Description                     | Default | Values          |
|------------------|---------------------------------|---------|-----------------|
| `NRDECO_ENABLED` | Controls instrumentation on/off | `false` | `true`, `false` |


> [!TIP]
> You can also enable instrumentation programmatically at application startup
> 
> `os.Setenv("NRDECO_ENABLED", "true")`
> 


## üìÑ License

**nrdeco** is released under the [MIT License](./LICENSE).

## üôè Acknowledgments

**nrdeco** is inspired by the following articles and projects

- [Go„Ç¢„Éó„É™„Å´Datadog APM„Éà„É¨„Éº„Çπ„ÇíËá™ÂãïÊåøÂÖ•„Åó„ÅüË©±](https://zenn.dev/edash_tech_blog/articles/11c6aeb43082a7)
- [budougumi0617/nrseg](https://github.com/budougumi0617/nrseg)

